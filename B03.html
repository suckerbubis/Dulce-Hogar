<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dulce Hogar ‚Äî Recuperar Contrase√±a (Bootstrap 5.3.3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bs-body-bg);
        }
        .forgot-password-box {
            max-width: 500px;
            width: 100%;
            background-color: var(--bs-secondary-bg-subtle);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 3rem 2rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5);
        }
        .forgot-password-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
        }
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        .steps-line {
            position: absolute;
            top: 20px;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--bs-border-color);
        }
        .step {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            background: var(--bs-border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 700;
            color: var(--bs-body-color);
            transition: background 0.3s;
        }
        .step.active .step-icon {
            background: var(--bs-primary);
            color: white;
        }
        .step.completed .step-icon {
            background: var(--bs-success);
            color: white;
        }
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .countdown {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--bs-primary);
            margin: 1rem 0;
        }
        .resend-link {
            cursor: pointer;
            font-weight: 600;
        }
        .resend-link.disabled {
            color: var(--bs-secondary-color) !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-sm-10 col-md-10 col-lg-8">
            <div class="forgot-password-box text-center text-light">
                <div class="forgot-password-icon">üîë</div>
                <h1 class="forgot-password-title fw-bold">Recuperar Contrase√±a</h1>
                <p class="text-secondary mb-4">Ingresa tu correo electr√≥nico para recibir instrucciones de recuperaci√≥n.</p>
                
                <div class="steps">
                    <div class="steps-line"></div>
                    <div class="step active" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-label text-secondary">Email</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-label text-secondary">C√≥digo</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-label text-secondary">Nueva Contrase√±a</div>
                    </div>
                </div>
                
                <div id="message-container" class="mb-4 text-start"></div>
                
                <div class="step-content active" id="step1-content">
                    <form id="email-form" class="text-start">
                        <div class="mb-3">
                            <label for="email" class="form-label text-secondary">Correo electr√≥nico</label>
                            <input type="email" id="email" class="form-control" placeholder="usuario@example.com" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold mt-2" id="send-code-btn">
                            Enviar c√≥digo de recuperaci√≥n
                        </button>
                    </form>
                </div>
                
                <div class="step-content" id="step2-content">
                    <p class="text-secondary">
                        Hemos enviado un c√≥digo de 6 d√≠gitos a tu correo. Ingresa el c√≥digo para continuar.
                    </p>
                    <div class="mb-3 text-start">
                        <label for="code" class="form-label text-secondary">C√≥digo de verificaci√≥n</label>
                        <input type="text" id="code" class="form-control" placeholder="123456" maxlength="6" required>
                    </div>
                    
                    <div class="countdown" id="countdown">05:00</div>
                    
                    <p class="small text-secondary">
                        ¬øNo recibiste el c√≥digo? 
                        <span id="resend-link" class="link-primary resend-link disabled">Reenviar en 00:30</span>
                    </p>
                    
                    <button class="btn btn-primary w-100 fw-bold mt-3" id="verify-code-btn">
                        Verificar c√≥digo
                    </button>
                </div>
                
                <div class="step-content" id="step3-content">
                    <form id="password-form" class="text-start">
                        <div class="mb-3">
                            <label for="new-password" class="form-label text-secondary">Nueva contrase√±a</label>
                            <input type="password" id="new-password" class="form-control" placeholder="M√≠nimo 8 caracteres" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label text-secondary">Confirmar nueva contrase√±a</label>
                            <input type="password" id="confirm-password" class="form-control" placeholder="Repite la contrase√±a" required>
                        </div>
                        
                        <div class="text-muted small mb-3">
                            <p class="fw-bold mb-1">Requisitos de contrase√±a:</p>
                            <ul>
                                <li>M√≠nimo 8 caracteres</li>
                                <li>Al menos una letra may√∫scula</li>
                                <li>Al menos un n√∫mero</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 fw-bold" id="reset-password-btn">
                            Cambiar contrase√±a
                        </button>
                    </form>
                </div>
                
                <a href="login.html" class="link-secondary d-block mt-4 text-decoration-none fw-bold">‚Üê Volver al inicio de sesi√≥n</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    let currentStep = 1;
    let countdownInterval;
    let resendCountdown = 30;
    let resendInterval;
    let userEmail = '';
    const EXPIRATION_TIME = 5 * 60; // 5 minutos en segundos

    document.addEventListener('DOMContentLoaded', setupEventListeners);
    
    // --- L√≥gica de Eventos ---
    function setupEventListeners() {
        document.getElementById('email-form').addEventListener('submit', function(e) {
            e.preventDefault();
            sendRecoveryEmail();
        });
        document.getElementById('verify-code-btn').addEventListener('click', verifyCode);
        document.getElementById('password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            resetPassword();
        });
        document.getElementById('resend-link').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) {
                resendCode();
            }
        });
    }
    
    // --- L√≥gica del API (Simulada) ---
    function sendRecoveryEmail() {
        const email = document.getElementById('email').value;
        const btn = document.getElementById('send-code-btn');
        
        if (!isValidEmail(email)) {
            showMessage('Ingresa un email v√°lido', 'danger');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Enviando...';
        
        // Simulaci√≥n: Llamada a API::recuperar
        setTimeout(() => {
            userEmail = email;
            showMessage(`Se ha enviado un c√≥digo a ${email}`, 'success');
            goToStep(2);
            startCountdown(); // Iniciar temporizador de expiraci√≥n de token
            btn.disabled = false;
            btn.textContent = 'Enviar c√≥digo de recuperaci√≥n';
        }, 1500);
    }
    
    function verifyCode() {
        const code = document.getElementById('code').value;
        const btn = document.getElementById('verify-code-btn');
        
        if (code.length !== 6) {
            showMessage('El c√≥digo debe tener 6 d√≠gitos', 'danger');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Verificando...';
        
        // Simulaci√≥n: Verificar el c√≥digo/token con el API
        setTimeout(() => {
            if (document.getElementById('countdown').textContent === 'C√≥digo expirado') {
                 // Simulaci√≥n de error: Token caducado (expDlg en B03.html)
                showMessage('El c√≥digo ha expirado. Solicita uno nuevo.', 'danger');
            } else if (code === '123456') { // C√≥digo de ejemplo
                showMessage('C√≥digo verificado correctamente', 'success');
                clearInterval(countdownInterval);
                goToStep(3);
            } else {
                showMessage('C√≥digo incorrecto. Intenta nuevamente.', 'danger');
            }
            
            btn.disabled = false;
            btn.textContent = 'Verificar c√≥digo';
        }, 1000);
    }
    
    function resetPassword() {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const btn = document.getElementById('reset-password-btn');
        
        if (newPassword !== confirmPassword) {
            showMessage('Las contrase√±as no coinciden', 'danger');
            return;
        }
        
        // Validaciones de seguridad de contrase√±a
        if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
            showMessage('La contrase√±a no cumple con los requisitos de seguridad (M√≠n. 8 caracteres, may√∫scula, n√∫mero)', 'danger');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Cambiando contrase√±a...';
        
        // Simulaci√≥n: Llamada final al API para cambiar la contrase√±a
        setTimeout(() => {
            showMessage('¬°Contrase√±a cambiada exitosamente!', 'success');
            
            setTimeout(() => {
                window.location.href = 'login.html'; // Redirigir al login
            }, 2000);
        }, 1500);
    }
    
    function resendCode() {
        if (userEmail) {
            showMessage(`C√≥digo reenviado a ${userEmail}`, 'info');
            startCountdown(); // Reinicia el temporizador de expiraci√≥n y reenv√≠o
        }
    }

    // --- L√≥gica de Interfaz de Usuario ---
    function goToStep(step) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));
        document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
        
        for (let i = 1; i <= step; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i < step) {
                stepEl.classList.add('completed');
            } else if (i === step) {
                stepEl.classList.add('active');
            }
        }
        document.getElementById(`step${step}-content`).classList.add('active');
        currentStep = step;
    }
    
    function startCountdown() {
        let timeLeft = EXPIRATION_TIME;
        const countdownEl = document.getElementById('countdown');
        const resendLink = document.getElementById('resend-link');
        
        clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                countdownEl.textContent = 'C√≥digo expirado';
            }
            timeLeft--;
        }, 1000);
        
        // Countdown para reenviar
        resendCountdown = 30;
        resendLink.classList.add('disabled');
        
        clearInterval(resendInterval);
        resendInterval = setInterval(() => {
            resendCountdown--;
            resendLink.textContent = `Reenviar en ${resendCountdown}s`;
            
            if (resendCountdown <= 0) {
                clearInterval(resendInterval);
                resendLink.classList.remove('disabled');
                resendLink.textContent = 'Reenviar c√≥digo';
            }
        }, 1000);
    }
    
    function showMessage(text, type) {
        const container = document.getElementById('message-container');
        const alert = document.createElement('div');
        // Usar clases de Bootstrap alert-success, alert-danger, alert-info
        alert.className = `alert alert-${type} mb-3`; 
        alert.setAttribute('role', 'alert');
        alert.textContent = text;
        
        container.innerHTML = '';
        container.appendChild(alert);
        
        // Eliminar mensaje despu√©s de 5 segundos
        setTimeout(() => { alert.remove(); }, 5000);
    }
    
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }
</script>
</body>
</html>
