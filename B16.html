<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dulce Hogar ‚Äî Programa de Puntos (Bootstrap 5.3.3)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: var(--bs-body-bg);
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .points-hero, .rules-card, .checkout-simulator, .transactions-card {
            background-color: var(--bs-secondary-bg-subtle);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            height: 100%;
        }
        .points-balance {
            font-size: 3rem;
            font-weight: 800;
            color: var(--bs-warning);
        }
        .rule-item, .transaction-item {
            padding: 0.75rem;
            border-radius: 0.3rem;
            margin-bottom: 0.5rem;
            background-color: var(--bs-dark);
        }
        .transaction-positive { color: var(--bs-success); }
        .transaction-negative { color: var(--bs-danger); }
        .level-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .level-bronze { background: #6c757d; color: white; }
        .level-silver { background: #adb5bd; color: white; }
        .level-gold { background: #ffc107; color: black; }
        .level-platinum { background: #17a2b8; color: white; }
        .progress-bar { height: 8px; margin: 1rem 0; }
        .checkout-total { font-size: 1.5rem; font-weight: 800; color: var(--bs-primary); }
    </style>
</head>
<body>

<main class="container">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="points-hero mb-4">
                <h1 class="text-light fw-bolder">‚≠ê Programa de Puntos</h1>
                <p class="text-secondary subtitle">Acumula y canjea descuentos con tus puntos Dulce Hogar.</p>
                
                <div class="points-balance" id="current-points">25</div>
                <div class="text-secondary small">puntos disponibles</div>
                
                <div class="mt-3">
                    <span class="level-badge level-silver" id="level-badge">Nivel Plata</span>
                    <span class="small text-muted" id="next-level-text">Pr√≥ximo nivel: 50 puntos</span>
                </div>
                
                <div class="progress" role="progressbar" aria-label="Progreso de nivel" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-warning" id="level-progress" style="width: 50%"></div>
                </div>
            </div>

            <div class="row g-4 points-grid">
                <div class="col-lg-8">
                    <div class="rules-card">
                        <h2 class="fs-5 fw-bolder mb-3 pb-2 border-bottom border-secondary">Reglas de Acumulaci√≥n y Canje</h2>
                        
                        <div class="rule-item d-flex justify-content-between">
                            <div><strong>Ganancia</strong><br><small class="text-muted">Por cada $1.000 de compra, ganas 1 punto.</small></div>
                            <div class="text-success fw-bold">+1 pt / $1k</div>
                        </div>
                        
                        <div class="rule-item d-flex justify-content-between">
                            <div><strong>Valor de canje</strong><br><small class="text-muted">Cada punto equivale a $100 de descuento.</small></div>
                            <div class="text-primary fw-bold">$100 / pt</div>
                        </div>
                        
                        <div class="rule-item d-flex justify-content-between">
                            <div><strong>Canje m√≠nimo</strong><br><small class="text-muted">Necesitas al menos 10 puntos para canjear.</small></div>
                            <div class="text-warning fw-bold">M√≠n. 10 pts</div>
                        </div>
                    </div>
                    
                    <div class="transactions-card mt-4">
                        <h2 class="fs-5 fw-bolder mb-3 pb-2 border-bottom border-secondary">Historial de Transacciones</h2>
                        <div id="transactions-list">
                            <div class="transaction-item d-flex justify-content-between">
                                <div><strong>Compra #2854</strong><br><small class="text-muted">15/05/2024 - Ganancia por $18.000</small></div>
                                <div class="transaction-positive fw-bold">+18 pts</div>
                            </div>
                            <div class="transaction-item d-flex justify-content-between">
                                <div><strong>Canje en Checkout</strong><br><small class="text-muted">10/05/2024 - Descuento aplicado</small></div>
                                <div class="transaction-negative fw-bold">-5 pts</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-sm btn-outline-secondary mt-3">
                            <i class="bi bi-file-earmark-arrow-down me-1"></i> Descargar historial
                        </button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="checkout-simulator">
                        <h2 class="fs-5 fw-bolder mb-3 pb-2 border-bottom border-secondary">Simulador de Checkout</h2>
                        
                        <div class="mb-3">
                            <label for="bruto" class="form-label small text-muted">Monto del pedido (bruto)</label>
                            <input id="bruto" type="number" min="0" value="15000" class="form-control bg-dark border-secondary text-light fw-bold">
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="usePts">
                            <label class="form-check-label text-light fw-bold" for="usePts">Aplicar puntos</label>
                        </div>
                        
                        <div class="alert alert-warning small p-2" id="warn" style="display:none">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> Necesitas m√≠nimo 10 puntos para canjear.
                        </div>

                        <div class="d-flex justify-content-between pt-3 border-top border-secondary-subtle">
                            <div class="small fw-bold">Puntos ganados (futuro)</div>
                            <div class="text-success fw-bold" id="earned-pts">15 pts</div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2 pt-2 border-top border-secondary-subtle">
                            <div class="small fw-bold">Descuento por puntos</div>
                            <div class="text-success fw-bold">$ <span id="desc">0</span></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-3 pt-3 border-top border-secondary-subtle">
                            <div class="fw-bolder fs-5">Total final</div>
                            <div class="checkout-total">$ <span id="final">15.000</span></div>
                        </div>

                        <button class="btn btn-primary w-100 fw-bolder mt-3" id="doPay">
                            <i class="bi bi-wallet-fill me-1"></i> Simular Pedido y Puntos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
const PTS_VALUE = 100;           // $ por punto
const MIN_REDEEM = 10;           // canje m√≠nimo
let currentPoints = 25;          // balance inicial (simulado)
const $ = s => document.querySelector(s);

const el = {
  bruto: $('#bruto'), use: $('#usePts'), pts: $('#current-points'),
  desc: $('#desc'), final: $('#final'), warn: $('#warn'), pay: $('#doPay'),
  earned: $('#earned-pts'), transactions: $('#transactions-list')
};

function fmt(n){ return (Math.round(n)).toLocaleString('es-CL'); }

function recalc(){
  const bruto = Math.max(0, Number(el.bruto.value||0));
  let balance = Number(el.pts.textContent||0);
  let descuento = 0;
  
  // 1. Puntos ganados (simulados antes del pago final)
  const earned = Math.floor(bruto / 1000);
  el.earned.textContent = `${earned} pts`;

  // 2. Canje y descuento
  if(el.use.checked){
    if(balance < MIN_REDEEM){
      el.warn.style.display='block';
    }else{
      el.warn.style.display='none';
      
      // L√≥gica de canje: Usar todos los disponibles, limitado por el total del pedido
      const maxByTotal = Math.floor(bruto / PTS_VALUE);
      // Usar la menor cantidad entre el balance y el m√°ximo posible del pedido
      const usar = Math.min(balance, maxByTotal);
      
      if (usar < MIN_REDEEM && usar > 0) {
          // Si los puntos que se pueden usar son menos del m√≠nimo, no se puede canjear
          el.warn.style.display='block';
          el.warn.textContent = `Puntos v√°lidos, pero solo puedes cubrir $${fmt(usar * PTS_VALUE)}, menos del m√≠nimo requerido ($${fmt(MIN_REDEEM * PTS_VALUE)}).`;
      } else {
          descuento = usar * PTS_VALUE;
      }
    }
  }else{
    el.warn.style.display='none';
  }

  const total = Math.max(0, bruto - descuento);
  el.desc.textContent = fmt(descuento);
  el.final.textContent = fmt(total);
}

function simulatePurchase() {
  const bruto = Math.max(0, Number(el.bruto.value||0));
  let balance = Number(el.pts.textContent||0);
  let descuento = Number(el.desc.textContent.replace(/\./g,'')); // Descuento en pesos

  if (el.use.checked && balance < MIN_REDEEM) {
      alert("No puedes realizar el pedido canjeando puntos. No cumples el m√≠nimo de canje.");
      return;
  }
  
  const total = Math.max(0, bruto - descuento);
  
  // Acreditaci√≥n de puntos (API Call: POST /api/points/transaction)
  const earned = Math.floor(total / 1000);
  const used = Math.floor(descuento / PTS_VALUE);

  const oldBalance = balance;
  balance = balance - used + earned;
  if(balance < 0) balance = 0;

  el.pts.textContent = balance;
  
  // A√±adir a historial (Simulaci√≥n)
  if (used > 0) {
      addTransaction('Canje en Checkout', used, false);
  }
  if (earned > 0) {
      addTransaction(`Compra $${fmt(bruto)}`, earned, true);
  }

  // Reset y rec√°lculo
  el.use.checked = false;
  recalc();

  alert(`üéâ Pedido pagado exitosamente (demo)\n\n` +
        `Puntos usados: ${used}\n` +
        `Puntos ganados: +${earned}\n` +
        `Nuevo balance: ${balance} pts\n\n` +
        `¬°Tu nivel de cliente ser√° actualizado!`);
}

function addTransaction(detail, points, earned) {
    const transactionEl = document.createElement('div');
    transactionEl.className = 'transaction-item d-flex justify-content-between';
    
    const sign = earned ? '+' : '-';
    const colorClass = earned ? 'transaction-positive' : 'transaction-negative';
    
    transactionEl.innerHTML = `
        <div><strong>${detail}</strong><br><small class="text-muted">${new Date().toLocaleDateString()}</small></div>
        <div class="${colorClass} fw-bold">${sign}${points} pts</div>
    `;
    el.transactions.prepend(transactionEl);
}


// --- Inicializaci√≥n ---
el.bruto.addEventListener('input', recalc);
el.use.addEventListener('change', recalc);
el.pay.addEventListener('click', simulatePurchase);

document.addEventListener('DOMContentLoaded', function() {
    el.pts.textContent = currentPoints;
    recalc();
});
</script>
</body>
</html>
